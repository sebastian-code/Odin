{% extends "base.html" %}
{% load markdown_deux_tags %}

{% block meta %}
{{ form.media }}
<link rel="stylesheet" href="{{ STATIC_URL }}css/assignment.css" />
{% endblock meta %}

{% block content %}
<div class="row">

    <div id="vote-for-partner" class="reveal-modal" data-reveal>
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <p>Моля посочeте към кои от партньорите на курса по {{ assignment.course }} проявявате интерес.</p>
            {{ vote_form.favourite_partners }}

            <p>
                Може да прикачите вашето CV ако искате то по-бързо да стигне до нашите партньори.
            </p>

            {{ vote_form.cv }}
            <button>Готово</button>
        </form>
        <a class="close-reveal-modal">&#215;</a>
    </div>

    <div id="give-feedback" class="reveal-modal" data-reveal>
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <p>Моля посочете къде сте започнали работа след курсът.</p>
            {{ feedback_form.error }}

            <div id="partner-selection-container">
                {{ feedback_form.partner }}
            </div>

            <div id="partner-name-input-container">
                <label>Име на компанията:</label>
                {{ feedback_form.partner_name }}
            </div>

            <button id="back-to-partners-list" name="button">Назад</button>
            <button id="cant-find-partner" name="button">Не намирам компанията в списъка</button>
            <button>Готово</button>
        </form>
        <a class="close-reveal-modal">&#215;</a>
    </div>

    <div class="large-12 columns">
        <div class="panel">
            <div class="row" id="course-page">
                <div class="medium-3 columns" style="padding-bottom: 20px;">
                    <img src="{{ assignment.user.get_avatar_url }}" class="th">
                </div>
                <h2>{{ assignment.course }} и {{ assignment.user.get_full_name }}</h2>

                {% if is_teacher %}
                    <div class="switch">
                      <input id="exampleCheckboxSwitch" type="checkbox">
                      <label for="exampleCheckboxSwitch"></label>
                    </div> 
                {% endif %}

                <div>
                    {% if is_teacher or is_hr %}
                    <p>
                        <a href="mailto:{{ assignment.user.email }}" target="_blank" id="email">Email акаунт: {{ assignment.user.email }}</a>
                    </p>
                    {% endif %}

                    <p>
                        <a href="{{ assignment.user.github_account }}" target="_blank">GitHub акаунт: {{ assignment.user.github_account }}</a>
                    </p>

                    {% if is_teacher or is_hr %}
                    <p>
                        <a href="{{ assignment.after_course_works_at.website }}" target="_blank">След курса започна работа в: {{ assignment.user.after_course_works_at }}</a>
                    </p>
                    {% endif %}

                    <hr>

                    {% if is_student and user == assignment.user %}
                        {% if assignment.course.ask_for_favorite_partner %}
                        <p class="text-center">
                            <button data-reveal-id="vote-for-partner">Посочете към кои от партньорите ни проявявате интерес</button>
                        </p>
                        {% endif %}

                        {% if assignment.course.ask_for_feedback and has_ended and not has_started_working_at %}
                        <p class="text-center">
                            <button data-reveal-id="give-feedback">Посочете къде сте започнали работа след курсът</button>
                        </p>
                        {% endif %}
                        <hr>
                    {% endif %}



                    <dl class="tabs" data-tab>
                        {% if is_student %}
                        <dd class="active"><a href="#comments">Коментари във форума</a></dd>
                        {% else %}
                            <dd class="active"><a href="#notes">Notes</a></dd>
                            <dd><a href="#comments">Коментари във форума</a></dd>
                        {% endif %}
                        {% if certificate %}
                            <dd><a id="certificate_url" href="{{ certificate.get_absolute_url }}" target="_blank">Сертификат</a></dd>
                        {% endif %}
                    </dl>

                    <div class="tabs-content">
                      <div class="content active" id="notes">
                          {% if is_teacher or is_hr %}
                              {% for note in notes %}
                              <p class="large-12 columns">
                                  <strong>{{ note.author.get_full_name }}</strong>:
                                  <br>
                                  <small>{{ note.post_time|date:"d-m-Y" }}</small>
                                  <br>{{ note.text | markdown }}
                                  <hr>
                              </p>
                              {% endfor %}
                          {% endif %}
                          {% if is_teacher %}
                              {{ form.errors }}
                              <form method="POST">
                                  {% csrf_token %} {{form.text}}
                                  <input type="hidden" name="assignment" value="{{ assignment.id }}">
                                  <button>Дайте коментар!</button>
                              </form>
                          {% endif %}
                      </div>
                      <div class="content" id="comments">
                        <p>
                            Всички ваши коментари (по теми в форума):
                            {% for comment in comments %}
                            <ul>
                                <li><a href="{% url 'forum:show_topic' comment.topic.id %}#{{ comment.id }}">{{ comment.topic }} #{{ comment.id }}</a>
                                </li>
                            </ul>
                            {% endfor %}
                        </p>
                      </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block jsfooter %}
    <script type="text/javascript" charset="utf-8">
        $(function() {
            var $partnerNameContainer = $("#partner-name-input-container"),
                $partnerSelectionContainer = $("#partner-selection-container"),
                $cantFindPartnerButton = $("#cant-find-partner"),
                $backButton = $("#back-to-partners-list");

            function hideAll(elements) {
                elements.forEach(function($el) {
                    $el.hide();
                });
            }

            function showAll(elements) {
                elements.forEach(function($el) {
                    $el.show();
                });
            }

            function defaultState() {
                var toShow = [],
                    toHide = [$partnerNameContainer, $backButton];

                showAll(toShow);
                hideAll(toHide);
            }

            function pickPartnerFromListState() {
                var toShow = [$cantFindPartnerButton, $partnerSelectionContainer],
                    toHide = [$backButton, $partnerNameContainer];

                showAll(toShow);
                hideAll(toHide);
            }

            function cantFindPartnerState() {
                var toShow = [$backButton, $partnerNameContainer],
                    toHide = [$cantFindPartnerButton, $partnerSelectionContainer];

                showAll(toShow);
                hideAll(toHide);
            }


            $cantFindPartnerButton.on("click", function(event) {
                event.preventDefault();
                cantFindPartnerState();
            });

            $backButton.on("click", function(event) {
                event.preventDefault();
                pickPartnerFromListState();
            });

            defaultState();
        });
    </script>
    <script charset="utf-8">
        $(document).ready(function () {
            var certificate = $('#certificate_url');
            certificate.on('click', function () {
                window.location = certificate.attr('href');
            });

            var $changeAssignmentActivity = $('#activity_switch');
            // {% if assignment.is_attending %}
            //     $changeAssignmentActivity.toggle();
            // {% endif %}
            $changeAssignmentActivity.change(function (event) {
                var id = $changeAssignmentActivity.data('id'),
                    sendTo = $changeAssignmentActivity.data('send-to');

                var deferred = $.post(sendTo, {id: id});
                deferred.done(function () {
                    $current.parents("div#activity").find("span").html("<i class=\"foundicon-checkmark\"></i>");
                });
                deferred.fail(function () {
                    $changeAssignmentActivity.parents("div#activity").find("span").html("<i class=\"foundicon-remove\"></i>");
                });
             });
        });
    </script>
{% endblock jsfooter %}
