{% extends "base.html" %}
{% load markdown_deux_tags %}

{% block meta %}
{{ form.media }}
<link rel="stylesheet" href="{{ STATIC_URL }}css/assignment.css" />
{% endblock meta %}

{% block content %}
<div class="row">

    <div id="vote-for-partner" class="reveal-modal" data-reveal>
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <p>Моля посочeте към кои от партньорите на курса по {{ assignment.course }} проявявате интерес.</p>
            {{ vote_form.favourite_partners }}

            <p>
                Може да прикачите вашето CV ако искате то по-бързо да стигне до нашите партньори.
            </p>

            {{ vote_form.cv }}
            <button>Готово</button>
        </form>
        <a class="close-reveal-modal">&#215;</a>
    </div>

    <div id="give-feedback" class="reveal-modal" data-reveal>
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <p>Моля посочете къде сте започнали работа след курсът.</p>
            {{ feedback_form.error }}

            <div id="partner-selection-container">
                {{ feedback_form.partner }}
            </div>

            <div id="partner-name-input-container">
                <label>Име на компанията:</label>
                {{ feedback_form.partner_name }}
            </div>

            <button id="back-to-partners-list" name="button">Назад</button>
            <button id="cant-find-partner" name="button">Не намирам компанията в списъка</button>
            <button>Готово</button>
        </form>
        <a class="close-reveal-modal">&#215;</a>
    </div>

    <div class="large-12 columns">
        <div class="panel">
            <div class="row" id="course-page">
                <div class="medium-3 columns" style="padding-bottom: 20px;">
                    <img src="{{ assignment.user.get_avatar_url }}" class="th">
                </div>
                <h2>{{ assignment.course }} и {{ assignment.user.get_full_name }}</h2>

                <div>
                    {% if is_teacher or is_hr %}
                    <p>
                        <a href="mailto:{{ assignment.user.email }}" target="_blank" id="email">Email акаунт: {{ assignment.user.email }}</a>
                    </p>
                    {% endif %}

                    <p>
                        <a href="{{ assignment.user.github_account }}" target="_blank">GitHub акаунт: {{ assignment.user.github_account }}</a>
                    </p>

                    {% if is_teacher or is_hr %}
                    <p>
                        <a href="{{ assignment.after_course_works_at.website }}" target="_blank">След курса започна работа в: {{ assignment.user.after_course_works_at }}</a>
                    </p>
                    {% endif %}

                    {% if certificate %}
                    <p>
                        <a href="{{ certificate.get_absolute_url }}" target="_blank">Сертификат от курса</a>
                    </p>
                    {% endif %}

                    <hr>

                    {% if is_student and user == assignment.user %}
                        {% if assignment.course.ask_for_favorite_partner %}
                        <p class="text-center">
                            <button data-reveal-id="vote-for-partner">Посочете към кои от партньорите ни проявявате интерес</button>
                        </p>
                        {% endif %}

                        {% if assignment.course.ask_for_feedback and has_ended and not has_started_working_at %}
                        <p class="text-center">
                            <button data-reveal-id="give-feedback">Посочете къде сте започнали работа след курсът</button>
                        </p>
                        {% endif %}
                    {% endif %}

                    <hr>

                    <p>
                        Всички ваши коментари (по теми в форума):
                        {% for comment in comments %}
                        <ul>
                            <li><a href="{% url 'forum:show_topic' comment.topic.id %}#{{ comment.id }}">{{ comment.topic }} #{{ comment.id }}</a>
                            </li>
                        </ul>
                        {% endfor %}
                    </p>
                </div>
                {% if is_teacher or is_hr %}
                    {% for note in notes %}
                    <p class="large-12 columns">
                        <strong>{{ note.author.get_full_name }}</strong>:
                        <br>
                        <small>{{ note.post_time|date:"d-m-Y" }}</small>
                        <br>{{ note.text | markdown }}
                        <hr>
                    </p>
                    {% endfor %}
                {% endif %}
                {% if is_teacher %}
                    {{ form.errors }}
                    <form method="POST">
                        {% csrf_token %} {{form.text}}
                        <input type="hidden" name="assignment" value="{{ assignment.id }}">
                        <button>Дайте коментар!</button>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block jsfooter %}
    <script type="text/javascript" charset="utf-8">
        $(function() {
            var $partnerNameContainer = $("#partner-name-input-container"),
                $partnerSelectionContainer = $("#partner-selection-container"),
                $cantFindPartnerButton = $("#cant-find-partner"),
                $backButton = $("#back-to-partners-list");

            function hideAll(elements) {
                elements.forEach(function($el) {
                    $el.hide();
                });
            }

            function showAll(elements) {
                elements.forEach(function($el) {
                    $el.show();
                });
            }

            function defaultState() {
                var toShow = [],
                    toHide = [$partnerNameContainer, $backButton];

                showAll(toShow);
                hideAll(toHide);
            }

            function pickPartnerFromListState() {
                var toShow = [$cantFindPartnerButton, $partnerSelectionContainer],
                    toHide = [$backButton, $partnerNameContainer];

                showAll(toShow);
                hideAll(toHide);
            }

            function cantFindPartnerState() {
                var toShow = [$backButton, $partnerNameContainer],
                    toHide = [$cantFindPartnerButton, $partnerSelectionContainer];

                showAll(toShow);
                hideAll(toHide);
            }


            $cantFindPartnerButton.on("click", function(event) {
                event.preventDefault();
                cantFindPartnerState();
            });

            $backButton.on("click", function(event) {
                event.preventDefault();
                pickPartnerFromListState();
            });

            defaultState();
        });
    </script>
{% endblock jsfooter %}
